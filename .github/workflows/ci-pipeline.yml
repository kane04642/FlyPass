name: CI Pipeline - Oficina Virtual

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci贸n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Configurar Gradle
        uses: gradle/gradle-build-action@v3

      - name: Ejecutar pruebas
        shell: pwsh
        run: ./gradlew clean test aggregate

      - name: Preparar carpetas build OV
        shell: pwsh
        run: |
          # Fecha del build
          $date = Get-Date -Format "yyyy-MM-dd_HHmmss"

          # SHA corto
          $sha = "${{ github.sha }}"
          $shortSha = $sha.Substring(0,7)

          # Variables del build
          $env:BUILD_NAME = "OficinaVirtual-$date-$shortSha"
          $env:BUILD_FOLDER = "build-OficinaVirtual-$date-$shortSha"

          Write-Host " Build: $env:BUILD_NAME"
          Write-Host " Folder: $env:BUILD_FOLDER"

          # Crear carpeta del build
          New-Item -ItemType Directory -Force -Path $env:BUILD_FOLDER | Out-Null

          # Copiar 煤nicamente reportes Serenity (estructura real de tu proyecto)
          Copy-Item "target/site/serenity" "$env:BUILD_FOLDER/serenity" -Recurse -Force

      - name: Generar portal HTML del build
        shell: pwsh
        run: |
          .\.github\scripts\generar-html.ps1 `
            -BuildName $env:BUILD_NAME `
            -BuildFolder $env:BUILD_FOLDER `
            -Storage "${{ secrets.AZURE_STORAGE_ACCOUNT }}"

      - name: Generar diagn贸stico
        shell: pwsh
        run: |
          .\.github\scripts\debug-deploy.ps1 `
            -BuildName $env:BUILD_NAME `
            -BuildFolder $env:BUILD_FOLDER `
            -StorageAccount "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            -SasToken "${{ secrets.AZURE_SAS_TOKEN }}"

      - name: Subir reportes a Azure Static Website
        shell: pwsh
        run: |
          .\.github\scripts\upload-to-azure.ps1 `
            -BuildFolder $env:BUILD_FOLDER `
            -StorageAccount "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            -SasToken "${{ secrets.AZURE_SAS_TOKEN }}"

      - name: Actualizar historial y generar Portal Maestro
        shell: pwsh
        run: |
          $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          $sasToken = "${{ secrets.AZURE_SAS_TOKEN }}"

          $baseUrl = "https://$storageAccount.z20.web.core.windows.net"
          $historyUrl = "$baseUrl/index.json`?$sasToken"

          # Intentar leer historial existente
          Write-Host " Leyendo historial existente (index.json) si existe..."
          $existingJson = "[]"
          try {
            $response = Invoke-RestMethod -Method Get -Uri $historyUrl -ErrorAction Stop
            if ($response) {
              $existingJson = $response | ConvertTo-Json -Depth 10
            }
          } catch {
            Write-Host "癸 No se encontr贸 historial previo, se crear谩 uno nuevo."
          }

          # Convertir historial existente
          $history = @()
          if (-not [string]::IsNullOrWhiteSpace($existingJson)) {
            $history = $existingJson | ConvertFrom-Json
          }

          if (-not $history) { $history = @() }

          # Nuevo item de build
          $item = [PSCustomObject]@{
            Nombre  = $env:BUILD_NAME
            Carpeta = $env:BUILD_FOLDER
            Fecha   = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
            SHA     = $sha.Substring(0,7)
            Storage = $storageAccount
          }

          # Eliminar duplicados por carpeta
          $history = $history | Where-Object { $_.Carpeta -ne $item.Carpeta }
          $history += $item

          # Ordenar por fecha descendente
          $history = $history | Sort-Object Fecha -Descending

          # Convertir a JSON y guardar local
          $historyJson = $history | ConvertTo-Json -Depth 5
          Set-Content -Path "index.json" -Value $historyJson -Encoding UTF8

          # Generar portal maestro con todo el historial
          .\.github\scripts\generar-portal-maestro.ps1 `
            -BuildsListJson $historyJson `
            -OutputFile "index.html"

      - name: Subir historial y Portal Maestro a Azure (index.json / index.html ra铆z)
        shell: pwsh
        run: |
          $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          $sasToken = "${{ secrets.AZURE_SAS_TOKEN }}"
          $baseUrl = "https://$storageAccount.z20.web.core.windows.net"

          $headers = @{ "x-ms-blob-type" = "BlockBlob" }

          $indexJsonUrl = "$baseUrl/index.json`?$sasToken"
          $indexHtmlUrl = "$baseUrl/index.html`?$sasToken"

          Write-Host "猬锔 Subiendo index.json (historial)..."
          Invoke-RestMethod -Method Put `
            -Uri $indexJsonUrl `
            -Headers $headers `
            -InFile "index.json" `
            -ContentType "application/json"

          Write-Host "猬锔 Subiendo index.html (portal maestro)..."
          Invoke-RestMethod -Method Put `
            -Uri $indexHtmlUrl `
            -Headers $headers `
            -InFile "index.html" `
            -ContentType "text/html"

          Write-Host " Portal maestro e historial actualizados correctamente en Azure."
