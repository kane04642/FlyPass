name: CI Pipeline - Oficina Virtual

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci√≥n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        shell: bash

      - name: Limpiar reportes previos
        run: ./gradlew clearReports
        shell: bash

      - name: Ejecutar escenarios de prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa
        shell: bash

      - name: Generar reportes Serenity
        run: ./gradlew aggregate -Denvironment=qa
        shell: bash

      - name: Instalar Azure CLI
        run: |
          Write-Host "Instalando Azure CLI..."
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi
        shell: pwsh

      - name: Generar nombre de build
        id: build-name
        shell: pwsh
        run: |
          $fecha = Get-Date -Format "yyyyMMdd-HHmmss"
          $commitShort = "${{ github.sha }}".Substring(0,7)
          $buildName = "OficinaVirtual-$fecha-$commitShort"
          echo "BUILD_NAME=$buildName" >> $env:GITHUB_ENV
          echo "BUILD_FOLDER=build-$buildName" >> $env:GITHUB_ENV
          Write-Host "Build generado: $buildName"

      - name: Preparar estructura de reportes
        shell: pwsh
        run: |
          Write-Host "Preparando estructura de reportes..."
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/serenity" -Force | Out-Null
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/jacoco" -Force | Out-Null

          Write-Host "Copiando reportes de Serenity..."
          Copy-Item -Path "target/site/serenity/*" -Destination "./$env:BUILD_FOLDER/serenity/" -Recurse -Force

          Write-Host "Copiando reportes de JaCoCo..."
          if (Test-Path "build/reports/jacoco/test/html") {
            Copy-Item -Path "build/reports/jacoco/test/html/*" -Destination "./$env:BUILD_FOLDER/jacoco/" -Recurse -Force
          } else {
            Write-Host "‚ö†Ô∏è JaCoCo no disponible, continuando..."
          }

      - name: Generar portal principal
        shell: pwsh
        run: |
          Write-Host "Generando portal principal..."
          $fecha = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
          $storage = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          $htmlContent = @()
          $htmlContent += '<!DOCTYPE html>'
          $htmlContent += '<html>'
          $htmlContent += '<head>'
          $htmlContent += '<meta charset="utf-8">'
          $htmlContent += '<title>Reportes - Oficina Virtual</title>'
          $htmlContent += '<style>'
          $htmlContent += 'body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }'
          $htmlContent += '.container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }'
          $htmlContent += 'h1 { color: #2c3e50; }'
          $htmlContent += '.btn { display: inline-block; padding: 10px 20px; margin: 10px; background: #3498db; color: white; text-decoration: none; border-radius: 5px; }'
          $htmlContent += '.btn-success { background: #27ae60; }'
          $htmlContent += '.btn-warning { background: #f39c12; }'
          $htmlContent += '</style>'
          $htmlContent += '</head>'
          $htmlContent += '<body>'
          $htmlContent += '<div class="container">'
          $htmlContent += '<h1>Reportes de Pruebas Automatizadas</h1>'
          $htmlContent += "<p><strong>Build:</strong> $env:BUILD_NAME</p>"
          $htmlContent += "<p><strong>Fecha:</strong> $fecha</p>"
          $htmlContent += '<div>'
          $htmlContent += "<a href='https://$storage.z20.web.core.windows.net/$env:BUILD_FOLDER/serenity/index.html' class='btn btn-success'>Reporte Serenity</a>"
          $htmlContent += "<a href='https://$storage.z20.web.core.windows.net/$env:BUILD_FOLDER/jacoco/index.html' class='btn btn-warning'>Reporte JaCoCo</a>"
          $htmlContent += "<a href='https://$storage.z20.web.core.windows.net/diagnostic.html' class='btn'>Diagn√≥stico</a>"
          $htmlContent += '</div>'
          $htmlContent += '</div>'
          $htmlContent += '</body>'
          $htmlContent += '</html>'

          $htmlContent -join "`n" | Out-File -FilePath "./index.html" -Encoding UTF8
          Write-Host "‚úÖ Portal principal generado"

      - name: Ejecutar diagn√≥stico y despliegue
        shell: pwsh
        run: |
          ./.github/scripts/debug-deploy.ps1 `
            -BuildName "$env:BUILD_NAME" `
            -BuildFolder "$env:BUILD_FOLDER" `
            -StorageAccount "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            -SasToken "${{ secrets.AZURE_SAS_TOKEN }}"

      - name: Mostrar URLs finales
        shell: pwsh
        run: |
          $storage = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          Write-Host ""
          Write-Host "üéâ PUBLICACI√ìN COMPLETADA"
          Write-Host "========================================"
          Write-Host "üåê Portal Principal: https://$storage.z20.web.core.windows.net/"
          Write-Host "üìä Reporte Serenity: https://$storage.z20.web.core.windows.net/$env:BUILD_FOLDER/serenity/index.html"
          Write-Host "üìà Reporte JaCoCo: https://$storage.z20.web.core.windows.net/$env:BUILD_FOLDER/jacoco/index.html"
          Write-Host "üîç Diagn√≥stico: https://$storage.z20.web.core.windows.net/diagnostic.html"
          Write-Host "========================================"

      - name: Publicar artifacts en GitHub
        uses: actions/upload-artifact@v4
        with:
          name: reportes-${{ env.BUILD_NAME }}
          path: |
            ${{ env.BUILD_FOLDER }}
            index.html
            diagnostic.html
          retention-days: 3

      - name: Fail if tests failed
        if: steps.test-execution.outcome == 'failure'
        run: exit 1
