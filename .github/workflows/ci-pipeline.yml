name: CI Pipeline - Oficina Virtual
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci√≥n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Limpiar Reportes
        run: ./gradlew clearReports

      - name: Ejecutar Escenarios de Prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa

      - name: Generar Reportes Serenity (siempre)
        run: ./gradlew aggregate -Denvironment=qa

      - name: Verificar reportes generados
        run: |
          if (Test-Path "target/site/serenity/index.html") {
            echo "‚úÖ Reportes de Serenity generados correctamente"
            Get-ChildItem "target/site/serenity" | Select-Object Name, Length | Format-Table
          } else {
            echo "‚ùå No se encontraron reportes de Serenity"
            exit 1
          }

      - name: Instalar Azure CLI
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi

      - name: Configurar estructura de reportes
        run: |
          # Crear directorio principal para reportes
          New-Item -ItemType Directory -Path "./reportes" -Force
          
          # Copiar reporte de Serenity a una subcarpeta
          New-Item -ItemType Directory -Path "./reportes/serenity" -Force
          Copy-Item -Path "target/site/serenity/*" -Destination "./reportes/serenity/" -Recurse -Force
          
          # Copiar reporte de JaCoCo a una subcarpeta
          New-Item -ItemType Directory -Path "./reportes/jacoco" -Force
          Copy-Item -Path "build/reports/jacoco/test/html/*" -Destination "./reportes/jacoco/" -Recurse -Force
          
          Write-Host "‚úÖ Estructura de reportes creada:"
          Get-ChildItem "./reportes" -Recurse | Select-Object FullName | Format-Table

      - name: Generar portal de reportes (index principal)
        run: |
          $reportPath = "./reportes"
          $portalFile = "$reportPath/index.html"
          
          # Verificar que los archivos destino existen
          Write-Host "üîç Verificando existencia de archivos..."
          $serenityIndex = Test-Path "$reportPath/serenity/index.html"
          $jacocoIndex = Test-Path "$reportPath/jacoco/index.html"
          $serenitySummary = Test-Path "$reportPath/serenity/summary.html"
          
          Write-Host "Serenity index.html: $serenityIndex"
          Write-Host "JaCoCo index.html: $jacocoIndex"
          Write-Host "Serenity summary.html: $serenitySummary"
          
          # Crear contenido HTML del portal
          $htmlContent = @"
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Portal de Reportes - Oficina Virtual</title>
              <style>
                  body { 
                      font-family: 'Segoe UI', Arial, sans-serif; 
                      margin: 0; 
                      padding: 0; 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container { 
                      max-width: 1200px; 
                      margin: 0 auto; 
                      padding: 40px 20px;
                  }
                  .header {
                      text-align: center;
                      color: white;
                      margin-bottom: 40px;
                  }
                  .header h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                  }
                  .header p {
                      font-size: 1.2em;
                      opacity: 0.9;
                  }
                  .cards-container {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                      gap: 20px;
                      margin-top: 30px;
                  }
                  .card {
                      background: white;
                      border-radius: 15px;
                      padding: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                      transition: transform 0.3s ease, box-shadow 0.3s ease;
                      border-left: 5px solid #3498db;
                  }
                  .card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
                  }
                  .card h3 {
                      color: #2c3e50;
                      margin-top: 0;
                      font-size: 1.4em;
                  }
                  .card p {
                      color: #7f8c8d;
                      line-height: 1.6;
                  }
                  .btn {
                      display: inline-block;
                      background: #3498db;
                      color: white;
                      padding: 12px 25px;
                      text-decoration: none;
                      border-radius: 25px;
                      font-weight: bold;
                      transition: background 0.3s ease;
                      margin-top: 15px;
                  }
                  .btn:hover {
                      background: #2980b9;
                  }
                  .btn-success {
                      background: #27ae60;
                  }
                  .btn-success:hover {
                      background: #219653;
                  }
                  .btn-warning {
                      background: #f39c12;
                  }
                  .btn-warning:hover {
                      background: #e67e22;
                  }
                  .timestamp {
                      text-align: center;
                      color: white;
                      margin-top: 40px;
                      opacity: 0.8;
                  }
                  .card-content {
                      min-height: 120px;
                  }
                  .file-status {
                      font-size: 0.9em;
                      margin-top: 10px;
                  }
                  .status-ok {
                      color: #27ae60;
                  }
                  .status-missing {
                      color: #e74c3c;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üöÄ Portal de Reportes de Pruebas</h1>
                      <p>Reportes generados autom√°ticamente por el pipeline de CI/CD</p>
                  </div>
          
                  <div class="cards-container">
                      <div class="card">
                          <div class="card-content">
                              <h3>üìä Reporte Principal Serenity</h3>
                              <p>Reporte detallado de las pruebas automatizadas con Serenity BDD. Incluye resultados, evidencias y m√©tricas de las pruebas ejecutadas.</p>
                              <div class="file-status">
          "@
          
          # Agregar estado del archivo Serenity
          if (Test-Path "$reportPath/serenity/index.html") {
              $htmlContent += '<span class="status-ok">‚úÖ Archivo disponible</span>'
          } else {
              $htmlContent += '<span class="status-missing">‚ùå Archivo no encontrado</span>'
          }
          
          $htmlContent += @"
                              </div>
                          </div>
                          <a href="serenity/index.html" class="btn btn-success" target="_blank">Abrir Reporte Completo</a>
                      </div>
          
                      <div class="card">
                          <div class="card-content">
                              <h3>üìà Cobertura de C√≥digo</h3>
                              <p>Reporte de cobertura de c√≥digo generado por JaCoCo. Muestra el porcentaje de c√≥digo cubierto por las pruebas automatizadas.</p>
                              <div class="file-status">
          "@
          
          # Agregar estado del archivo JaCoCo
          if (Test-Path "$reportPath/jacoco/index.html") {
              $htmlContent += '<span class="status-ok">‚úÖ Archivo disponible</span>'
          } else {
              $htmlContent += '<span class="status-missing">‚ùå Archivo no encontrado</span>'
          }
          
          $htmlContent += @"
                              </div>
                          </div>
                          <a href="jacoco/index.html" class="btn btn-warning" target="_blank">Ver Cobertura</a>
                      </div>
          
                      <div class="card">
                          <div class="card-content">
                              <h3>üìã Resumen Ejecutivo</h3>
                              <p>Resumen general de la ejecuci√≥n de pruebas con estad√≠sticas, duraci√≥n y resultados agrupados por caracter√≠sticas.</p>
                              <div class="file-status">
          "@
          
          # Agregar estado del archivo Summary
          if (Test-Path "$reportPath/serenity/summary.html") {
              $htmlContent += '<span class="status-ok">‚úÖ Archivo disponible</span>'
          } else {
              $htmlContent += '<span class="status-missing">‚ùå Archivo no encontrado</span>'
          }
          
          $htmlContent += @"
                              </div>
                          </div>
                          <a href="serenity/summary.html" class="btn" target="_blank">Ver Resumen</a>
                      </div>
                  </div>
          
                  <div class="timestamp">
                      <p>Generado el: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
                  </div>
              </div>
          
              <script>
                  // Verificar enlaces y mostrar alertas si no existen
                  document.addEventListener('DOMContentLoaded', function() {
                      const links = document.querySelectorAll('a[target="_blank"]');
                      links.forEach(link => {
                          link.addEventListener('click', function(e) {
                              const href = this.getAttribute('href');
                              fetch(href, { method: 'HEAD' })
                                  .then(response => {
                                      if (!response.ok) {
                                          e.preventDefault();
                                          alert('El archivo ' + href + ' no est√° disponible. Puede que no se haya generado correctamente.');
                                      }
                                  })
                                  .catch(() => {
                                      e.preventDefault();
                                      alert('El archivo ' + href + ' no est√° disponible. Puede que no se haya generado correctamente.');
                                  });
                          });
                      });
                  });
              </script>
          </body>
          </html>
          "@
          
          # Escribir el archivo portal
          $htmlContent | Out-File -FilePath $portalFile -Encoding UTF8
          Write-Host "‚úÖ Portal de reportes generado correctamente en: $portalFile"

      - name: Verificar estructura final
        run: |
          Write-Host "üìÅ Estructura final de reportes:"
          Get-ChildItem "./reportes" -Recurse | Select-Object FullName | Format-Table
          
          Write-Host "üîç Verificando archivos cr√≠ticos:"
          $criticalFiles = @(
              "./reportes/index.html",
              "./reportes/serenity/index.html", 
              "./reportes/jacoco/index.html"
          )
          
          foreach ($file in $criticalFiles) {
              if (Test-Path $file) {
                  Write-Host "‚úÖ $file" -ForegroundColor Green
              } else {
                  Write-Host "‚ùå $file - NO ENCONTRADO" -ForegroundColor Red
              }
          }

      - name: Verificar configuraci√≥n de Azure
        run: |
          Write-Host "üîç Verificando configuraci√≥n de Azure..."
          Write-Host "Storage Account: ${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          if ([string]::IsNullOrEmpty('${{ secrets.AZURE_STORAGE_KEY }}')) {
            Write-Host "‚ùå ERROR: AZURE_STORAGE_KEY no est√° configurado"
            exit 1
          } else {
            Write-Host "‚úÖ AZURE_STORAGE_KEY est√° configurado"
          }

      - name: Subir reportes a Azure Storage con Azure CLI
        run: |
          Write-Host "üîê Conectando a Azure Storage: ${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          
          # Subir todos los archivos usando upload-batch
          az storage blob upload-batch `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --destination '$web' `
            --source ./reportes `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --overwrite
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ Todos los archivos subidos exitosamente a Azure Storage" -ForegroundColor Green
          } else {
              Write-Host "‚ùå Error al subir archivos a Azure Storage" -ForegroundColor Red
              exit 1
          }

      - name: Publicar Reporte de Cobertura JaCoCo
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: build/reports/jacoco/test/html/

      - name: Publicar Reporte Serenity
        uses: actions/upload-artifact@v4
        with:
          name: serenity-report
          path: target/site/serenity/

      - name: Publicar Reporte JaCoCo XML
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml-report
          path: build/reports/jacoco/test/jacocoTestReport.xml

      - name: Mostrar URL de reportes
        run: |
          $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          echo "üìä Portal de Reportes: https://$storageAccount.z6.web.core.windows.net/"
          echo "üîó Reporte Serenity: https://$storageAccount.z6.web.core.windows.net/serenity/index.html"
          echo "üìà Cobertura JaCoCo: https://$storageAccount.z6.web.core.windows.net/jacoco/index.html"
          echo "üìã Resumen Ejecutivo: https://$storageAccount.z6.web.core.windows.net/serenity/summary.html"
          echo "üïê Publicado en: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"

      - name: Fail if tests failed
        if: steps.test-execution.outcome == 'failure'
        run: exit 1