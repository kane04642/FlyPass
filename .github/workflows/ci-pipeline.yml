name: CI Pipeline - Oficina Virtual
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci√≥n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Limpiar Reportes
        run: ./gradlew clearReports

      - name: Ejecutar Escenarios de Prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa

      - name: Generar Reportes Serenity (siempre)
        run: ./gradlew aggregate -Denvironment=qa

      - name: Verificar reportes generados
        run: |
          if (Test-Path "target/site/serenity/index.html") {
            echo "‚úÖ Reportes de Serenity generados correctamente"
          } else {
            echo "‚ùå No se encontraron reportes de Serenity"
            exit 1
          }

      - name: Instalar Azure CLI
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi

      - name: Generar nombre personalizado para la ejecuci√≥n
        id: build-name
        run: |
          $fecha = Get-Date -Format "yyyy-MM-dd-HHmmss"
          $commitShort = "${{ github.sha }}".Substring(0,7)
          $buildName = "OficinaVirtual-${fecha}-${commitShort}"
          echo "BUILD_NAME=$buildName" >> $env:GITHUB_ENV
          echo "BUILD_FOLDER=build-$buildName" >> $env:GITHUB_ENV
          echo "Nombre de build: $buildName"

      - name: Preparar estructura de reportes
        run: |
          # Crear estructura de carpetas
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/serenity" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/jacoco" -Force
          
          Write-Host "üìÅ Estructura creada: $env:BUILD_FOLDER"

      - name: Copiar reportes de Serenity
        run: |
          Write-Host "üìã Copiando reportes de Serenity..."
          if (Test-Path "target/site/serenity") {
              Copy-Item -Path "target/site/serenity/*" -Destination "./$env:BUILD_FOLDER/serenity/" -Recurse -Force
              Write-Host "‚úÖ Reportes de Serenity copiados"
          
              # Verificar archivos copiados
              Write-Host "üìÑ Archivos en serenity:"
              Get-ChildItem "./$env:BUILD_FOLDER/serenity" | Select-Object Name, Length | Format-Table
          } else {
              Write-Host "‚ùå No se encontr√≥ target/site/serenity"
              exit 1
          }

      - name: Copiar reportes de JaCoCo
        run: |
          Write-Host "üìä Copiando reportes de JaCoCo..."
          if (Test-Path "build/reports/jacoco/test/html") {
              Copy-Item -Path "build/reports/jacoco/test/html/*" -Destination "./$env:BUILD_FOLDER/jacoco/" -Recurse -Force
              Write-Host "‚úÖ Reportes de JaCoCo copiados"
          
              # Verificar archivos copiados
              Write-Host "üìÑ Archivos en jacoco:"
              Get-ChildItem "./$env:BUILD_FOLDER/jacoco" | Select-Object Name, Length | Format-Table
          } else {
              Write-Host "‚ö†Ô∏è No se encontr√≥ build/reports/jacoco/test/html - Continuando sin reporte de cobertura"
          }

      - name: Verificar estructura final
        run: |
          Write-Host "üîç Verificando estructura final..."
          $criticalFiles = @(
              "./$env:BUILD_FOLDER/serenity/index.html",
              "./$env:BUILD_FOLDER/jacoco/index.html"
          )
          
          foreach ($file in $criticalFiles) {
              if (Test-Path $file) {
                  Write-Host "‚úÖ $file" -ForegroundColor Green
              } else {
                  Write-Host "‚ö†Ô∏è $file - No encontrado" -ForegroundColor Yellow
              }
          }
          
          Write-Host "üìÇ Estructura completa:"
          Get-ChildItem "./$env:BUILD_FOLDER" -Recurse | Select-Object FullName | Format-Table

      - name: Generar portal principal
        run: |
          $portalContent = @"
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Portal de Reportes - Oficina Virtual</title>
              <style>
                  body { 
                      font-family: 'Segoe UI', Arial, sans-serif; 
                      margin: 0; 
                      padding: 0; 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container { 
                      max-width: 1200px; 
                      margin: 0 auto; 
                      padding: 40px 20px;
                  }
                  .header {
                      text-align: center;
                      color: white;
                      margin-bottom: 40px;
                  }
                  .header h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                  }
                  .current-build {
                      background: white;
                      border-radius: 15px;
                      padding: 30px;
                      margin-bottom: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                      border-left: 5px solid #27ae60;
                  }
                  .btn {
                      display: inline-block;
                      background: #3498db;
                      color: white;
                      padding: 12px 25px;
                      text-decoration: none;
                      border-radius: 25px;
                      font-weight: bold;
                      margin: 10px 5px;
                      transition: all 0.3s ease;
                  }
                  .btn:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                  }
                  .btn-success {
                      background: #27ae60;
                  }
                  .btn-success:hover {
                      background: #219653;
                  }
                  .btn-warning {
                      background: #f39c12;
                  }
                  .btn-warning:hover {
                      background: #e67e22;
                  }
                  .build-info {
                      background: #f8f9fa;
                      padding: 15px;
                      border-radius: 8px;
                      margin: 15px 0;
                  }
                  .file-status {
                      margin-top: 10px;
                  }
                  .status-ok {
                      color: #27ae60;
                      font-weight: bold;
                  }
                  .status-missing {
                      color: #e74c3c;
                      font-weight: bold;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üöÄ Portal de Reportes de Pruebas</h1>
                      <p>Ejecuciones automatizadas - Oficina Virtual</p>
                  </div>
          
                  <div class="current-build">
                      <h2>üìã Ejecuci√≥n M√°s Reciente</h2>
                      <div class="build-info">
                          <p><strong>Nombre:</strong> $env:BUILD_NAME</p>
                          <p><strong>Commit:</strong> ${{ github.sha }}</p>
                          <p><strong>Fecha:</strong> $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
                          <p><strong>Carpeta:</strong> $env:BUILD_FOLDER</p>
                      </div>
          
                      <div class="file-status">
          "@
          
          # Verificar archivos y agregar botones condicionalmente
          $serenityExists = Test-Path "./$env:BUILD_FOLDER/serenity/index.html"
          $jacocoExists = Test-Path "./$env:BUILD_FOLDER/jacoco/index.html"
          
          if ($serenityExists) {
              $portalContent += @"
                          <a href="$env:BUILD_FOLDER/serenity/index.html" class="btn btn-success" target="_blank">
                              üìä Reporte Serenity Completo
                          </a>
          "@
          } else {
              $portalContent += @'
                          <span class="status-missing">‚ùå Reporte Serenity no disponible</span>
  '@
          }
          
          if ($jacocoExists) {
              $portalContent += @"
                          <a href="$env:BUILD_FOLDER/jacoco/index.html" class="btn btn-warning" target="_blank">
                              üìà Cobertura de C√≥digo JaCoCo
                          </a>
          "@
          } else {
              $portalContent += @'
  <span class="status-missing">‚ùå Reporte JaCoCo no disponible</span>
  '@
          }
          
          $portalContent += @"
                      </div>
                  </div>
                  
                  <div style="text-align: center; color: white;">
                      <p><em>üí° Cada ejecuci√≥n se conserva en una carpeta independiente con nombre descriptivo</em></p>
                      <p>üïê Portal generado el: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
                  </div>
              </div>
              
              <script>
                  // Verificar enlaces antes de navegar
                  document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a.btn');
  links.forEach(link => {
  link.addEventListener('click', function(e) {
  const href = this.getAttribute('href');
  // No hacemos verificaci√≥n adicional para permitir la navegaci√≥n
  console.log('Navegando a:', href);
  });
  });
  });
  </script>
  </body>
  </html>
  "@
  
  $portalContent | Out-File -FilePath "./index.html" -Encoding UTF8
  Write-Host "‚úÖ Portal principal generado con verificaci√≥n de archivos"

- name: Subir TODO a Azure Storage
  run: |
    Write-Host "üîê Subiendo reportes a Azure Storage..."
    
    # Subir el portal principal (index.html)
    az storage blob upload `
      --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
      --container-name '$web' `
      --file "./index.html" `
      --name "index.html" `
      --auth-mode key `
      --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
      --overwrite
    
    # Subir la carpeta de build completa
    az storage blob upload-batch `
      --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
      --destination '$web' `
      --source "./$env:BUILD_FOLDER" `
      --auth-mode key `
      --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
      --overwrite
    
    Write-Host "‚úÖ Build '$env:BUILD_NAME' subida exitosamente a Azure Storage"

- name: Mostrar URLs de acceso
  run: |
    $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
    echo " "
    echo "üåê ==========================================="
    echo "üìä PORTAL PRINCIPAL DE REPORTES"
    echo "üåê ==========================================="
    echo "üîó URL Principal: https://$storageAccount.z6.web.core.windows.net/"
    echo " "
    echo "üöÄ EJECUCI√ìN ACTUAL: $env:BUILD_NAME"
    echo "üîó Reporte Serenity: https://$storageAccount.z6.web.core.windows.net/$env:BUILD_FOLDER/serenity/index.html"
    echo "üìà Cobertura JaCoCo: https://$storageAccount.z6.web.core.windows.net/$env:BUILD_FOLDER/jacoco/index.html"
    echo " "
    echo "üìÅ Carpeta en Azure: $env:BUILD_FOLDER"
    echo "üïê Publicado el: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
    echo "üåê ==========================================="

- name: Publicar artifacts en GitHub (backup)
  uses: actions/upload-artifact@v4
  with:
    name: reportes-$env:BUILD_NAME
    path: |
      ${{ env.BUILD_FOLDER }}
      index.html
    retention-days: 7

- name: Fail if tests failed
  if: steps.test-execution.outcome == 'failure'
  run: exit 1