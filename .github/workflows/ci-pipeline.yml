name: CI Pipeline - Oficina Virtual

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci√≥n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout c√≥digo fuente
        uses: actions/checkout@v4

      - name: Configurar Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Configurar Gradle
        uses: gradle/gradle-build-action@v3

      - name: Compilar y ejecutar pruebas
        run: |
          ./gradlew clean test aggregate

      - name: Generar portal principal
        shell: pwsh
        run: |
          $date = Get-Date -Format "yyyy-MM-dd_HHmmss"
          $env:BUILD_NAME = "OficinaVirtual-$date-${{ github.sha.Substring(0,7) }}"
          $env:BUILD_FOLDER = "build-OficinaVirtual-$date-${{ github.sha.Substring(0,7) }}"
          Write-Host "üì¶ Nombre del build: $env:BUILD_NAME"
          Write-Host "üìÅ Carpeta del build: $env:BUILD_FOLDER"

          # Crear carpetas de reportes
          New-Item -ItemType Directory -Force -Path $env:BUILD_FOLDER | Out-Null
          Copy-Item -Path "target/site/serenity" -Destination "$env:BUILD_FOLDER/serenity" -Recurse -Force
          Copy-Item -Path "target/site/jacoco" -Destination "$env:BUILD_FOLDER/jacoco" -Recurse -Force

          # Storage account
          $storage = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"

          # HTML principal
          $htmlContent = @"
  <!DOCTYPE html>
  <html>
  <head>
  <meta charset=""utf-8"">
  <title>Reportes - Oficina Virtual</title>
  <style>
body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
.container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
h1 { color: #2c3e50; }
.btn { display: inline-block; padding: 10px 20px; margin: 10px; background: #3498db; color: white; text-decoration: none; border-radius: 4px; }
.btn-success { background: #27ae60; }
.btn-warning { background: #f39c12; }
  </style>
  </head>
  <body>
  <div class=""container"">
  <h1>Reportes de Pruebas Automatizadas</h1>
  <p><strong>Build:</strong> $env:BUILD_NAME</p>
  <p><strong>Fecha:</strong> $(Get-Date)</p>
  <div>
  <a href=""https://$storage.z20.web.core.windows.net/$env:BUILD_FOLDER/serenity/index.html"" class=""btn btn-success"">Reporte Serenity</a>
  <a href=""https://$storage.z20.web.core.windows.net/$env:BUILD_FOLDER/jacoco/index.html"" class=""btn btn-warning"">Reporte Jacoco</a>
  <a href=""https://$storage.z20.web.core.windows.net/$env:BUILD_FOLDER/diagnostic.html"" class=""btn"">Diagn√≥stico</a>
  </div>
  </div>
  </body>
  </html>
  "@

          Set-Content -Path "$env:BUILD_FOLDER\index.html" -Value $htmlContent -Encoding UTF8
  Write-Host "‚úÖ Portal principal generado"

- name: Ejecutar diagn√≥stico y despliegue
  shell: pwsh
  run: |
    Write-Host "üöÄ Ejecutando script debug-deploy.ps1..."
    
    $scriptPath = ".\\.github\\scripts\\debug-deploy.ps1"
    
    if (-Not (Test-Path $scriptPath)) {
      Write-Error "‚ùå No se encontr√≥ el script en la ruta esperada: $scriptPath"
      exit 1
    }
    
    Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
    
    & $scriptPath `
      -BuildName "$env:BUILD_NAME" `
      -BuildFolder "$env:BUILD_FOLDER" `
      -StorageAccount "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
      -SasToken "${{ secrets.AZURE_SAS_TOKEN }}"
