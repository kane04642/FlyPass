name: CI Pipeline - Oficina Virtual
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: EjecuciÃ³n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Limpiar Reportes
        run: ./gradlew clearReports

      - name: Ejecutar Escenarios de Prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa

      - name: Generar Reportes Serenity
        run: ./gradlew aggregate -Denvironment=qa

      - name: Instalar Azure CLI
        run: |
          Write-Host "Instalando Azure CLI..."
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi

      - name: Generar nombre de build
        id: build-name
        run: |
          $fecha = Get-Date -Format "yyyyMMdd-HHmmss"
          $commitShort = "${{ github.sha }}".Substring(0,7)
          $buildName = "OficinaVirtual-$fecha-$commitShort"
          echo "BUILD_NAME=$buildName" >> $env:GITHUB_ENV
          echo "BUILD_FOLDER=build-$buildName" >> $env:GITHUB_ENV
          Write-Host "Build generado: $buildName"

      - name: Preparar estructura de reportes
        run: |
          Write-Host "Preparando estructura de reportes..."
          
          # Crear directorios
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/serenity" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/jacoco" -Force
          
          # Copiar reportes
          Write-Host "Copiando reportes de Serenity..."
          Copy-Item -Path "target/site/serenity/*" -Destination "./$env:BUILD_FOLDER/serenity/" -Recurse -Force
          
          Write-Host "Copiando reportes de JaCoCo..."
          if (Test-Path "build/reports/jacoco/test/html") {
              Copy-Item -Path "build/reports/jacoco/test/html/*" -Destination "./$env:BUILD_FOLDER/jacoco/" -Recurse -Force
          } else {
              Write-Host "JaCoCo no disponible, continuando..."
          }

      - name: Desplegar reportes a Azure
        run: |
          ./.github/scripts/deploy-reports.ps1 `
            -BuildName "$env:BUILD_NAME" `
            -BuildFolder "$env:BUILD_FOLDER" `
            -StorageAccount "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            -StorageKey "${{ secrets.AZURE_STORAGE_KEY }}"

      - name: Publicar artifacts en GitHub
        uses: actions/upload-artifact@v4
        with:
          name: reportes-${{ env.BUILD_NAME }}
          path: |
            ${{ env.BUILD_FOLDER }}
            index.html
          retention-days: 3

      - name: Fail if tests failed
        if: steps.test-execution.outcome == 'failure'
        run: exit 1