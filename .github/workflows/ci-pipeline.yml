name: CI Pipeline - Oficina Virtual
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci√≥n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Limpiar Reportes
        run: ./gradlew clearReports

      - name: Ejecutar Escenarios de Prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa

      - name: Generar Reportes Serenity (siempre)
        run: ./gradlew aggregate -Denvironment=qa

      - name: Verificar reportes generados
        run: |
          if (Test-Path "target/site/serenity/index.html") {
            echo "‚úÖ Reportes de Serenity generados correctamente"
            Get-ChildItem "target/site/serenity" | Select-Object Name, Length | Format-Table
          } else {
            echo "‚ùå No se encontraron reportes de Serenity"
            exit 1
          }

      - name: Instalar Azure CLI
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi

      - name: Configurar directorio de reportes
        run: |
          # Crear directorio para reportes
          New-Item -ItemType Directory -Path "./reportes" -Force
          # Copiar todo el contenido de serenity al directorio reportes
          Copy-Item -Path "target/site/serenity/*" -Destination "./reportes/" -Recurse -Force

      - name: Generar index.html con enlaces a reportes
        run: |
          $reportPath = "./reportes"
          $indexFile = "$reportPath/index.html"
          
          # Crear contenido HTML b√°sico
          $htmlContent = @"
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Reportes de Pruebas - Oficina Virtual</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                  .report-list { list-style: none; padding: 0; }
                  .report-item { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #3498db; }
                  .report-item a { text-decoration: none; color: #2c3e50; font-weight: bold; font-size: 16px; }
                  .report-item a:hover { color: #3498db; }
                  .timestamp { color: #7f8c8d; font-size: 14px; margin-top: 5px; }
                  .success { border-left-color: #27ae60; }
                  .info { border-left-color: #3498db; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üìä Reportes de Pruebas Automatizadas</h1>
                  <p>Reportes generados autom√°ticamente por el pipeline de CI/CD</p>
          
                  <ul class="report-list">
          "@
          
          # Agregar archivos principales
          $mainFiles = @(
              @{Name = "Reporte Principal Serenity"; File = "index.html"; Class = "success"},
              @{Name = "Cobertura de C√≥digo"; File = "jacoco/index.html"; Class = "info"},
              @{Name = "Resumen de Pruebas"; File = "summary.html"; Class = "info"}
          )
          
          foreach ($file in $mainFiles) {
              if (Test-Path "$reportPath/$($file.File)") {
                  $htmlContent += @"
                  <li class="report-item $($file.Class)">
                      <a href="$($file.File)" target="_blank">$($file.Name)</a>
                      <div class="timestamp">Archivo: $($file.File)</div>
                  </li>
          "@
              }
          }
          
          # Cerrar HTML
          $htmlContent += @"
                  </ul>
                  <div class="timestamp">Generado el: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</div>
              </div>
          </body>
          </html>
          "@
          
          # Escribir el archivo index.html
          $htmlContent | Out-File -FilePath $indexFile -Encoding UTF8
          Write-Host "‚úÖ Index.html generado correctamente en: $indexFile"

      - name: Subir reportes a Azure Storage con Azure CLI
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          Write-Host "üîê Conectando a Azure Storage: $env:AZURE_STORAGE_ACCOUNT"
          
          # Subir todos los archivos usando upload-batch
          az storage blob upload-batch `
            --account-name $env:AZURE_STORAGE_ACCOUNT `
            --destination '$web' `
            --source ./reportes `
            --auth-mode key `
            --account-key $env:AZURE_STORAGE_KEY `
            --overwrite
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ Todos los archivos subidos exitosamente a Azure Storage" -ForegroundColor Green
          } else {
              Write-Host "‚ùå Error al subir archivos a Azure Storage" -ForegroundColor Red
              exit 1
          }

      - name: Publicar Reporte de Cobertura JaCoCo
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: build/reports/jacoco/test/html/

      - name: Publicar Reporte Serenity
        uses: actions/upload-artifact@v4
        with:
          name: serenity-report
          path: target/site/serenity/

      - name: Publicar Reporte JaCoCo XML
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml-report
          path: build/reports/jacoco/test/jacocoTestReport.xml

      - name: Mostrar URL de reportes
        run: |
          $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          echo "üìä Reportes publicados en: https://$storageAccount.z6.web.core.windows.net/"
          echo "üìã Reporte principal: https://$storageAccount.z6.web.core.windows.net/index.html"
          echo "üïê Publicado en: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"

      - name: Fail if tests failed
        if: steps.test-execution.outcome == 'failure'
        run: exit 1