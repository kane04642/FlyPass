name: CI Pipeline - Oficina Virtual
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci√≥n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Limpiar Reportes
        run: ./gradlew clearReports

      - name: Ejecutar Escenarios de Prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa

      - name: Generar Reportes Serenity (siempre)
        run: ./gradlew aggregate -Denvironment=qa

      - name: Verificar reportes generados
        run: |
          if (Test-Path "target/site/serenity/index.html") {
            echo "Reportes de Serenity generados correctamente"
            Get-ChildItem "target/site/serenity" | Select-Object Name | Format-Table
          } else {
            echo "No se encontraron reportes de Serenity"
            Get-ChildItem "target/site" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName | Format-Table
            exit 1
          }

      - name: Instalar Azure CLI
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi

      - name: Generar nombre personalizado para la ejecuci√≥n
        id: build-name
        run: |
          $fecha = Get-Date -Format "yyyyMMdd-HHmmss"
          $commitShort = "${{ github.sha }}".Substring(0,7)
          $buildName = "OficinaVirtual-${fecha}-${commitShort}"
          echo "BUILD_NAME=$buildName" >> $env:GITHUB_ENV
          echo "BUILD_FOLDER=build-$buildName" >> $env:GITHUB_ENV
          echo "Nombre de build: $buildName"

      - name: Preparar estructura de reportes
        run: |
          Write-Host "Creando estructura de carpetas..."
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/serenity" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/jacoco" -Force
          Write-Host "Estructura creada: $env:BUILD_FOLDER"

      - name: Copiar reportes de Serenity
        run: |
          Write-Host "Copiando reportes de Serenity..."
          if (Test-Path "target/site/serenity") {
              Write-Host "Contenido de target/site/serenity:"
              Get-ChildItem "target/site/serenity" | Select-Object Name, Length | Format-Table
          
              Copy-Item -Path "target/site/serenity/*" -Destination "./$env:BUILD_FOLDER/serenity/" -Recurse -Force
              Write-Host "Reportes de Serenity copiados"
          
              Write-Host "Verificando copia:"
              Get-ChildItem "./$env:BUILD_FOLDER/serenity" | Select-Object Name, Length | Format-Table
          } else {
              Write-Host "ERROR: No se encontro target/site/serenity"
              Get-ChildItem "target" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName | Format-Table
              exit 1
          }

      - name: Copiar reportes de JaCoCo
        run: |
          Write-Host "Copiando reportes de JaCoCo..."
          if (Test-Path "build/reports/jacoco/test/html") {
              Write-Host "Contenido de build/reports/jacoco/test/html:"
              Get-ChildItem "build/reports/jacoco/test/html" | Select-Object Name, Length | Format-Table
          
              Copy-Item -Path "build/reports/jacoco/test/html/*" -Destination "./$env:BUILD_FOLDER/jacoco/" -Recurse -Force
              Write-Host "Reportes de JaCoCo copiados"
          
              Write-Host "Verificando copia:"
              Get-ChildItem "./$env:BUILD_FOLDER/jacoco" | Select-Object Name, Length | Format-Table
          } else {
              Write-Host "ADVERTENCIA: No se encontro build/reports/jacoco/test/html - Continuando sin reporte de cobertura"
              Get-ChildItem "build/reports" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName | Format-Table
          }

      - name: Verificar estructura final
        run: |
          Write-Host "=== VERIFICACION ESTRUCTURA FINAL ==="
          Write-Host "Contenido de la carpeta build:"
          Get-ChildItem "./$env:BUILD_FOLDER" -Recurse | Select-Object FullName | Format-Table
          
          $criticalFiles = @(
              "./$env:BUILD_FOLDER/serenity/index.html",
              "./$env:BUILD_FOLDER/jacoco/index.html"
          )
          
          Write-Host "Verificando archivos criticos:"
          foreach ($file in $criticalFiles) {
              if (Test-Path $file) {
                  Write-Host "‚úÖ $file" -ForegroundColor Green
              } else {
                  Write-Host "‚ùå $file - NO ENCONTRADO" -ForegroundColor Red
              }
          }
          
          $serenityExists = Test-Path "./$env:BUILD_FOLDER/serenity/index.html"
          $jacocoExists = Test-Path "./$env:BUILD_FOLDER/jacoco/index.html"
          
          echo "SERENITY_EXISTS=$serenityExists" >> $env:GITHUB_ENV
          echo "JACOCO_EXISTS=$jacocoExists" >> $env:GITHUB_ENV
          
          Write-Host "Resumen:"
          Write-Host "Serenity existe: $serenityExists"
          Write-Host "JaCoCo existe: $jacocoExists"

      - name: Generar portal principal usando script externo
        run: |
          ./.github/scripts/generate-portal.ps1 -BuildName "$env:BUILD_NAME" -BuildFolder "$env:BUILD_FOLDER" -CommitSha "${{ github.sha }}" -SerenityExists "$env:SERENITY_EXISTS" -JacocoExists "$env:JACOCO_EXISTS"

      - name: Verificar archivos a subir
        run: |
          Write-Host "=== ARCHIVOS A SUBIR A AZURE ==="
          Write-Host "Contenido del directorio raiz:"
          Get-ChildItem "." | Select-Object Name | Format-Table
          
          Write-Host "Contenido de la carpeta build:"
          Get-ChildItem "./$env:BUILD_FOLDER" -Recurse | Select-Object Name | Format-Table

      - name: Subir portal principal a Azure Storage
        run: |
          Write-Host "Subiendo portal principal a Azure Storage..."
          az storage blob upload `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --container-name '$web' `
            --file "./index.html" `
            --name "index.html" `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --overwrite
          Write-Host "‚úÖ Portal principal subido"

      - name: Subir carpeta de build a Azure Storage
        run: |
          Write-Host "Subiendo carpeta de build a Azure Storage..."
          az storage blob upload-batch `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --destination '$web' `
            --source "./$env:BUILD_FOLDER" `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --overwrite
          Write-Host "‚úÖ Carpeta de build subida"

      - name: Verificar archivos subidos a Azure
        run: |
          Write-Host "Verificando archivos en Azure Storage..."
          az storage blob list `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --container-name '$web' `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --query "[].name" `
            --output table

      - name: Mostrar URLs de acceso
        run: |
          $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          echo ""
          echo "üåê PORTAL PRINCIPAL DE REPORTES"
          echo "üåê ==========================================="
          echo "üîó URL Principal: https://$storageAccount.z6.web.core.windows.net/"
          echo ""
          echo "üöÄ EJECUCION ACTUAL: $env:BUILD_NAME"
          echo "üìä Reporte Serenity: https://$storageAccount.z6.web.core.windows.net/$env:BUILD_FOLDER/serenity/index.html"
          echo "üìà Cobertura JaCoCo: https://$storageAccount.z6.web.core.windows.net/$env:BUILD_FOLDER/jacoco/index.html"
          echo ""
          echo "üìÅ Carpeta en Azure: $env:BUILD_FOLDER"
          echo "üïê Publicado el: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          echo "üåê ==========================================="

      - name: Publicar artifacts en GitHub (backup)
        uses: actions/upload-artifact@v4
        with:
          name: reportes-${{ env.BUILD_NAME }}
          path: |
            ${{ env.BUILD_FOLDER }}
            index.html
          retention-days: 7

      - name: Fail if tests failed
        if: steps.test-execution.outcome == 'failure'
        run: exit 1