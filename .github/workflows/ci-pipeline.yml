name: CI Pipeline - Oficina Virtual
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecuci√≥n Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Limpiar Reportes
        run: ./gradlew clearReports

      - name: Ejecutar Escenarios de Prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa

      - name: Generar Reportes Serenity (siempre)
        run: ./gradlew aggregate -Denvironment=qa

      - name: Verificar reportes generados
        run: |
          if (Test-Path "target/site/serenity/index.html") {
            echo "‚úÖ Reportes de Serenity generados correctamente"
          } else {
            echo "‚ùå No se encontraron reportes de Serenity"
            exit 1
          }

      - name: Instalar Azure CLI
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi

      - name: Generar ID √∫nico de build
        id: build-id
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
          $commitShort = "${{ github.sha }}".Substring(0,7)
          $buildId = "${timestamp}-${commitShort}"
          echo "BUILD_ID=$buildId" >> $env:GITHUB_ENV
          echo "Build ID: $buildId"

      - name: Preparar estructura con historial
        run: |
          # Crear carpeta para esta build espec√≠fica
          $buildDir = "build-$env:BUILD_ID"
          New-Item -ItemType Directory -Path "./$buildDir" -Force
          New-Item -ItemType Directory -Path "./$buildDir/serenity" -Force
          New-Item -ItemType Directory -Path "./$buildDir/jacoco" -Force
          
          # Copiar reportes a la carpeta de build
          Copy-Item -Path "target/site/serenity/*" -Destination "./$buildDir/serenity/" -Recurse -Force
          Copy-Item -Path "build/reports/jacoco/test/html/*" -Destination "./$buildDir/jacoco/" -Recurse -Force
          
          Write-Host "‚úÖ Estructura preparada para: $buildDir"

      - name: Generar portal principal con historial
        run: |
          $portalContent = @"
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Portal de Reportes - Historial</title>
              <style>
                  body { 
                      font-family: 'Segoe UI', Arial, sans-serif; 
                      margin: 0; 
                      padding: 0; 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container { 
                      max-width: 1000px; 
                      margin: 0 auto; 
                      padding: 40px 20px;
                  }
                  .header {
                      text-align: center;
                      color: white;
                      margin-bottom: 40px;
                  }
                  .current-build {
                      background: white;
                      border-radius: 15px;
                      padding: 30px;
                      margin-bottom: 30px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                      border-left: 5px solid #27ae60;
                  }
                  .btn {
                      display: inline-block;
                      background: #3498db;
                      color: white;
                      padding: 12px 25px;
                      text-decoration: none;
                      border-radius: 25px;
                      font-weight: bold;
                      margin: 5px;
                  }
                  .btn-success {
                      background: #27ae60;
                  }
                  .build-info {
                      color: #7f8c8d;
                      margin-top: 10px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üöÄ Historial de Reportes de Pruebas</h1>
                      <p>Ejecuciones automatizadas - Oficina Virtual</p>
                  </div>
          
                  <div class="current-build">
                      <h2>üìã Ejecuci√≥n M√°s Reciente</h2>
                      <p><strong>Build ID:</strong> $env:BUILD_ID</p>
                      <p><strong>Commit:</strong> ${{ github.sha }}</p>
                      <p><strong>Fecha:</strong> $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
          
                      <a href="build-$env:BUILD_ID/serenity/index.html" class="btn btn-success">üìä Reporte Serenity</a>
                      <a href="build-$env:BUILD_ID/jacoco/index.html" class="btn">üìà Cobertura JaCoCo</a>
                  </div>
          
                  <div style="text-align: center; color: white;">
                      <p><em>Cada ejecuci√≥n se conserva en una carpeta independiente</em></p>
                      <p>üïê Portal generado el: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
                  </div>
              </div>
          </body>
          </html>
          "@
          
          $portalContent | Out-File -FilePath "./index.html" -Encoding UTF8
          Write-Host "‚úÖ Portal principal generado"

      - name: Subir reportes con historial a Azure Storage
        run: |
          Write-Host "üîê Subiendo reportes a Azure Storage..."
          
          # Subir el portal principal
          az storage blob upload `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --container-name '$web' `
            --file "./index.html" `
            --name "index.html" `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --overwrite
          
          # Subir la carpeta de build completa
          az storage blob upload-batch `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --destination '$web' `
            --source "./build-$env:BUILD_ID" `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --overwrite
          
          Write-Host "‚úÖ Build $env:BUILD_ID subida exitosamente"

      - name: Mostrar URLs de reportes
        run: |
          $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          echo "üìä Portal Principal: https://$storageAccount.z6.web.core.windows.net/"
          echo "üöÄ Build Actual: https://$storageAccount.z6.web.core.windows.net/build-$env:BUILD_ID/serenity/index.html"
          echo "üîó Reporte Serenity: https://$storageAccount.z6.web.core.windows.net/build-$env:BUILD_ID/serenity/index.html"
          echo "üìà Cobertura JaCoCo: https://$storageAccount.z6.web.core.windows.net/build-$env:BUILD_ID/jacoco/index.html"
          echo "üÜî Build ID: $env:BUILD_ID"
          echo "üíæ Esta ejecuci√≥n se conservar√° en el historial"

      - name: Fail if tests failed
        if: steps.test-execution.outcome == 'failure'
        run: exit 1