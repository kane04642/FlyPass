name: CI Pipeline - Oficina Virtual
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  escenarios-oficina-virtual:
    name: Ejecución Escenarios OV
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          architecture: x64

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Limpiar Reportes
        run: ./gradlew clearReports

      - name: Ejecutar Escenarios de Prueba
        id: test-execution
        continue-on-error: true
        run: ./gradlew clean test jacocoTestReport aggregate -Denvironment=qa

      - name: Generar Reportes Serenity (siempre)
        run: ./gradlew aggregate -Denvironment=qa

      - name: Verificar reportes generados
        run: |
          if (Test-Path "target/site/serenity/index.html") {
            echo "Reportes de Serenity generados correctamente"
          } else {
            echo "No se encontraron reportes de Serenity"
            exit 1
          }

      - name: Instalar Azure CLI
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          Remove-Item AzureCLI.msi

      - name: Generar nombre personalizado para la ejecución
        id: build-name
        run: |
          $fecha = Get-Date -Format "yyyy-MM-dd-HHmmss"
          $commitShort = "${{ github.sha }}".Substring(0,7)
          $buildName = "OficinaVirtual-${fecha}-${commitShort}"
          echo "BUILD_NAME=$buildName" >> $env:GITHUB_ENV
          echo "BUILD_FOLDER=build-$buildName" >> $env:GITHUB_ENV
          echo "Nombre de build: $buildName"

      - name: Preparar estructura de reportes
        run: |
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/serenity" -Force
          New-Item -ItemType Directory -Path "./$env:BUILD_FOLDER/jacoco" -Force
          Write-Host "Estructura creada: $env:BUILD_FOLDER"

      - name: Copiar reportes de Serenity
        run: |
          Write-Host "Copiando reportes de Serenity..."
          if (Test-Path "target/site/serenity") {
              Copy-Item -Path "target/site/serenity/*" -Destination "./$env:BUILD_FOLDER/serenity/" -Recurse -Force
              Write-Host "Reportes de Serenity copiados"
          } else {
              Write-Host "No se encontro target/site/serenity"
              exit 1
          }

      - name: Copiar reportes de JaCoCo
        run: |
          Write-Host "Copiando reportes de JaCoCo..."
          if (Test-Path "build/reports/jacoco/test/html") {
              Copy-Item -Path "build/reports/jacoco/test/html/*" -Destination "./$env:BUILD_FOLDER/jacoco/" -Recurse -Force
              Write-Host "Reportes de JaCoCo copiados"
          } else {
              Write-Host "No se encontro build/reports/jacoco/test/html - Continuando sin reporte de cobertura"
          }

      - name: Verificar estructura final
        run: |
          Write-Host "Verificando estructura final..."
          $serenityExists = Test-Path "./$env:BUILD_FOLDER/serenity/index.html"
          $jacocoExists = Test-Path "./$env:BUILD_FOLDER/jacoco/index.html"
          
          echo "SERENITY_EXISTS=$serenityExists" >> $env:GITHUB_ENV
          echo "JACOCO_EXISTS=$jacocoExists" >> $env:GITHUB_ENV
          
          Write-Host "Serenity existe: $serenityExists"
          Write-Host "JaCoCo existe: $jacocoExists"

      - name: Generar portal principal usando script externo
        run: |
          ./.github/scripts/generate-portal.ps1 -BuildName "$env:BUILD_NAME" -BuildFolder "$env:BUILD_FOLDER" -CommitSha "${{ github.sha }}" -SerenityExists:$env:SERENITY_EXISTS -JacocoExists:$env:JACOCO_EXISTS

      - name: Subir TODO a Azure Storage
        run: |
          Write-Host "Subiendo reportes a Azure Storage..."
          
          az storage blob upload `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --container-name '$web' `
            --file "./index.html" `
            --name "index.html" `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --overwrite
          
          az storage blob upload-batch `
            --account-name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" `
            --destination '$web' `
            --source "./$env:BUILD_FOLDER" `
            --auth-mode key `
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" `
            --overwrite
          
          Write-Host "Build '$env:BUILD_NAME' subida exitosamente a Azure Storage"

      - name: Mostrar URLs de acceso
        run: |
          $storageAccount = "${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          echo " "
          echo "PORTAL PRINCIPAL DE REPORTES"
          echo "URL Principal: https://$storageAccount.z6.web.core.windows.net/"
          echo " "
          echo "EJECUCION ACTUAL: $env:BUILD_NAME"
          echo "Reporte Serenity: https://$storageAccount.z6.web.core.windows.net/$env:BUILD_FOLDER/serenity/index.html"
          echo "Cobertura JaCoCo: https://$storageAccount.z6.web.core.windows.net/$env:BUILD_FOLDER/jacoco/index.html"
          echo " "
          echo "Carpeta en Azure: $env:BUILD_FOLDER"
          echo "Publicado el: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"

      - name: Publicar artifacts en GitHub
        uses: actions/upload-artifact@v4
        with:
          name: reportes-$env:BUILD_NAME
          path: |
            ${{ env.BUILD_FOLDER }}
            index.html
          retention-days: 7

      - name: Fail if tests failed
        if: steps.test-execution.outcome == 'failure'
        run: exit 1